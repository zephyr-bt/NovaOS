<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus | Identity Engine</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'], outfit: ['Outfit', 'sans-serif'] },
                    colors: { page: '#050505', panel: '#0f0f0f', border: '#222' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #050505; color: #fff; height: 100dvh; overflow: hidden; }
        .input-dark { background: #0a0a0a; border: 1px solid #222; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; transition: 0.2s; font-size: 13px; }
        .input-dark:focus { border-color: #555; }
        /* Toast */
        #toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px); background: #fff; color: #000; padding: 10px 20px; border-radius: 99px; font-weight: bold; font-size: 12px; z-index: 9999; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        #toast.show { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body class="flex flex-col md:flex-row text-sm">

    <div id="toast"><div id="toast-icon"></div> <span id="toast-msg">Notification</span></div>

    <div id="view-app" class="hidden fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center p-4">
        <div id="view-bg" class="absolute inset-0 bg-cover bg-center opacity-30"></div>
        <div class="relative z-10 w-full max-w-[400px] bg-black/80 backdrop-blur-xl border border-white/10 rounded-[32px] p-8 text-center">
            <img id="v-avatar" src="" class="w-24 h-24 rounded-full border-2 border-white/20 mx-auto mb-4 object-cover bg-zinc-900">
            <h1 id="v-name" class="text-3xl font-outfit font-bold text-white mb-1">...</h1>
            <div id="v-role" class="inline-block px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-mono uppercase text-zinc-400 mb-6">...</div>
            <p id="v-bio" class="text-zinc-400 text-sm mb-8">...</p>
            <div id="v-links" class="space-y-3"></div>
            <div class="mt-8 opacity-30 text-[10px] font-mono tracking-widest">NEXUS ID</div>
        </div>
    </div>

    <aside id="editor-sidebar" class="w-full md:w-[500px] bg-panel border-r border-border flex flex-col h-full z-20 shadow-2xl relative">
        <header class="h-16 px-6 border-b border-border flex items-center justify-between bg-black/50 backdrop-blur-md sticky top-0 z-30">
            <div class="flex items-center gap-2 font-bold tracking-tight text-lg">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_red]"></div>
                Nexus<span class="text-zinc-500">Edit</span>
            </div>
            <button id="btn-save" class="bg-white text-black px-6 py-2 rounded-lg text-xs font-bold hover:bg-zinc-200 transition shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                PUBLISH
            </button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 space-y-6 pb-32">
            <div class="space-y-3">
                <div class="flex justify-between items-end">
                    <label class="text-[10px] font-mono text-zinc-500 uppercase">Handle (Required)</label>
                </div>
                <div class="relative">
                    <span class="absolute left-3 top-3 text-zinc-500">@</span>
                    <input id="in-username" type="text" class="input-dark pl-7 !bg-black !border-zinc-800 focus:!border-white" placeholder="username">
                </div>
            </div>

            <hr class="border-border">

            <div class="grid grid-cols-2 gap-3">
                <input id="in-name" type="text" class="input-dark" placeholder="Display Name">
                <input id="in-role" type="text" class="input-dark" placeholder="Role / Tagline">
            </div>
            <textarea id="in-bio" rows="3" class="input-dark resize-none" placeholder="Bio..."></textarea>
            
            <div class="space-y-2">
                <input id="in-gh" class="input-dark" placeholder="GitHub Username">
                <input id="in-tw" class="input-dark" placeholder="Twitter Handle">
                <input id="in-web" class="input-dark" placeholder="Website URL">
            </div>

            <hr class="border-border">
            
            <div class="space-y-2">
                 <label class="text-[10px] font-mono text-zinc-500 uppercase">Visuals</label>
                 <input id="in-bg" class="input-dark" placeholder="Background Image URL">
                 <div class="grid grid-cols-6 gap-2" id="color-grid"></div>
            </div>
        </div>
    </aside>

    <main class="flex-1 bg-black hidden md:flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
        <div class="text-zinc-600 font-mono text-xs">PREVIEW MODE // WAITING FOR INPUT</div>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCAGwej9kwnaf9XyqreS2kM9_NLpEa6dOM",
            authDomain: "nexusbio.firebaseapp.com",
            projectId: "nexusbio",
            storageBucket: "nexusbio.firebasestorage.app",
            messagingSenderId: "742997204418",
            appId: "1:742997204418:web:78084566fbdb81198c8a5b"
        };

        let db;
        let state = { color: '#ffffff' };

        window.onload = () => {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                document.getElementById('status-dot').classList.replace('bg-red-500', 'bg-green-500');
                document.getElementById('status-dot').classList.add('shadow-[0_0_10px_#00ff00]');
                initColors();
            } catch(e) {
                console.error(e);
                alert("FIREBASE INIT FAILED: " + e.message);
            }

            // Router
            let path = window.location.pathname.substring(1);
            const query = new URLSearchParams(window.location.search).get('u');
            const user = path || query;

            if (user && user !== 'index.html') {
                document.getElementById('editor-sidebar').classList.add('hidden');
                document.querySelector('main').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                loadProfile(user);
            }
        };

        // --- SAVE FUNCTION (WITH ERROR DETECTOR) ---
        document.getElementById('btn-save').addEventListener('click', async () => {
            const username = document.getElementById('in-username').value.trim().toLowerCase();
            
            // Check 1: Empty Username
            if(!username) {
                alert("⚠️ PLEASE ENTER A USERNAME");
                return;
            }

            // Check 2: Database Connection
            if(!db) {
                alert("⚠️ DATABASE NOT CONNECTED. Check your internet.");
                return;
            }

            const btn = document.getElementById('btn-save');
            btn.innerText = "SAVING...";

            try {
                // Attempt Write
                await db.collection("users").doc(username).set({
                    name: document.getElementById('in-name').value,
                    role: document.getElementById('in-role').value,
                    bio: document.getElementById('in-bio').value,
                    bgUrl: document.getElementById('in-bg').value,
                    links: {
                        gh: document.getElementById('in-gh').value,
                        tw: document.getElementById('in-tw').value,
                        web: document.getElementById('in-web').value
                    },
                    theme: state.color,
                    timestamp: new Date()
                });

                // SUCCESS
                btn.innerText = "PUBLISHED!";
                const link = `${window.location.origin}/?u=${username}`;
                prompt("✅ SUCCESS! Your Profile is Live:", link);

            } catch(e) {
                // FAILURE - DIAGNOSIS
                console.error(e);
                btn.innerText = "FAILED";

                if (e.code === 'permission-denied') {
                    alert("❌ ERROR: PERMISSION DENIED\n\nGoogle has locked your database.\n\nYOU MUST GO TO FIREBASE CONSOLE -> FIRESTORE -> RULES AND CHANGE 'FALSE' TO 'TRUE'.");
                } else if (e.code === 'unavailable') {
                    alert("❌ ERROR: NETWORK\n\nYou are offline or your firewall is blocking Firebase.");
                } else {
                    alert("❌ ERROR: " + e.message);
                }
            }
        });

        // --- UTILS ---
        function initColors() {
            const colors = ['#ffffff', '#ef4444', '#f97316', '#f59e0b', '#84cc16', '#10b981', '#06b6d4', '#3b82f6', '#8b5cf6', '#d946ef', '#f43f5e'];
            const grid = document.getElementById('color-grid');
            colors.forEach(c => {
                const btn = document.createElement('div');
                btn.className = 'w-6 h-6 rounded-full cursor-pointer border border-transparent hover:scale-125 transition';
                btn.style.backgroundColor = c;
                btn.onclick = () => state.color = c;
                grid.appendChild(btn);
            });
        }

        async function loadProfile(user) {
            try {
                const doc = await db.collection("users").doc(user).get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('v-name').innerText = data.name;
                    document.getElementById('v-role').innerText = data.role;
                    document.getElementById('v-bio').innerText = data.bio;
                    document.getElementById('v-avatar').src = `https://ui-avatars.com/api/?name=${data.name}&background=111&color=fff`;
                    
                    if(data.bgUrl) document.getElementById('view-bg').style.backgroundImage = `url(${data.bgUrl})`;
                    
                    document.getElementById('v-name').style.color = data.theme;
                    document.getElementById('v-role').style.color = data.theme;
                    document.getElementById('v-role').style.borderColor = data.theme + '40';

                    const lContainer = document.getElementById('v-links');
                    if(data.links.gh) lContainer.innerHTML += createLink('github', 'GitHub', data.links.gh);
                    if(data.links.tw) lContainer.innerHTML += createLink('twitter', 'Twitter', data.links.tw);
                    if(data.links.web) lContainer.innerHTML += createLink('globe', 'Website', data.links.web);
                    lucide.createIcons();
                } else {
                    alert("User not found");
                    window.location.href = '/';
                }
            } catch(e) { console.error(e); }
        }

        function createLink(icon, label, url) {
            const finalUrl = url.startsWith('http') ? url : `https://${url}`;
            return `<a href="${finalUrl}" target="_blank" class="flex items-center justify-between p-4 bg-white/5 border border-white/5 hover:bg-white/10 hover:scale-[1.02] transition rounded-xl group">
                <div class="flex items-center gap-3">
                    <i data-lucide="${icon}" class="w-4 h-4 text-zinc-400 group-hover:text-white transition"></i>
                    <span class="font-bold text-zinc-300 group-hover:text-white">${label}</span>
                </div>
            </a>`;
        }
    </script>
</body>
</html>
